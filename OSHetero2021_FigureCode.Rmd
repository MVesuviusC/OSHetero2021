---
title: "OSHetero2021"
author: "Sanjana Rajan, Emily Franz, Matthew Cannon"
date: "`r format(Sys.time(), '%m/%d/%Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: false
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  echo = TRUE,
  cache = TRUE,
  collapse = TRUE,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE,
  cache.lazy = FALSE
)
```

*Seurat object loading and processing code can be found in "OSHetero2021_Load_Process.Rmd". Object outputs from that code are loaded in the code below.*

# Figure 1

**Cell line and PDX models of osteosarcoma display transcriptional heterogeneity.**

```{r Fig1_lib, cache=FALSE}
source("scSeurat.R")
source("Downstream.v2.R")
set.seed(888)
# loading libraries
library(Seurat)
library(future)
library(ggplot2)
library(msigdbr)
library(clusterProfiler)
library(SingleR)
library(dplyr)
library(pheatmap)
library(RColorBrewer)
library(viridis) # inferno color palette
library(grid)
library(ggsci)
library(data.table)
library(ggvenn)
library(tibble)
library(tidyr)
library(tidyverse)
library(stringr)
library(reshape2)
library(pzfx)
library(ggridges)
library(effsize)
library(perm)
```

## Figure 1A

*DONE*

A) UMAP analysis of OS-17 cells (n = 3178) grown in cell culture. Cell cycle distribution of cells (n = 3178) is visualized as pie charts.

```{r Fig1a_OS17}
load("Data/os17.cx_CCR.RData")

# Culture plot
figure1_a1 <- DimPlot(os17.cx,
                      reduction = "umap",
                      pt.size = 1,
                      label = T) +
  coord_fixed() +
  ggtitle("OS17 in Culture") +
  NoAxes() +
  scale_color_npg(alpha = 1)

# View Culture plot in Rmd
figure1_a1

# Save as pdf
pdf("figures/figure_1/figure_1a_os17.pdf",
    width = 5,
    height = 5)
figure1_a1
dev.off()


# Cell cycle distribution of clusters
cid <- sort(unique(os17.cx@active.ident))

vplayout <- function(x, y) viewport(layout.pos.row = x,
                                    layout.pos.col = y)


pdf("figures/figure_1/figure_1a_os17_pie.pdf",
    width = 6,
    height = 2)

grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 4)))

for(i in 1:3){
  temp <- WhichCells(os17.cx,
                     idents = cid[[i]])
  LT.cells <- subset(os17.cx,
                     cells = temp)
  df <- table(LT.cells$Phase)
  bp <- ggplot(as.data.frame(df),
               aes(x = "",
                   y = Freq,
                   fill = Var1)) +
    geom_bar(width = 1,
             stat = "identity")
  pie <- bp +
    coord_polar("y",
                start = 0) +
    scale_fill_brewer(palette ="Blues") +
    theme_minimal() +
    NoAxes() + NoLegend() +
    ggtitle(paste("Cluster",
                  cid[[i]]))
  print(pie,
        vp = vplayout(ceiling(i/4),
                      i))
}
dev.off()
```

## Figure 1B

*DONE*

B) UMAP analysis of NCH-OS-7 cells (n = 1998) grown as subcutaneous flank tumor. Cell cycle distribution of cells is visualized as pie charts.

```{r Fig1b_NCHOS7}
load(file ="Data/OS7.cx_CCR.RData")

# Flank plots

figure_1b <- DimPlot(OS7.cx,
                     reduction = "umap",
                     pt.size = 1,
                     label = T) + 
  coord_fixed() + 
  ggtitle("NCHOS7 in Flank") +
  NoAxes() +
  scale_color_npg(alpha = 1)

# View in Rmd
figure_1b

# Save as pdf
pdf("figures/figure_1/figure_1b_nchos7.pdf",
    width = 5,
    height = 5)
figure_1b
dev.off()

# Cell cycle distribution of clusters
cid <- sort(unique(OS7.cx@active.ident))

vplayout <- function(x, y) viewport(layout.pos.row = x, layout.pos.col = y)

pdf("figures/figure_1/figure_1b_nchos7_pie.pdf",
    width = 6,
    height = 2)

grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 4)))
for(i in 1:4){
  temp <- WhichCells(OS7.cx,
                     idents = cid[[i]]) 
  LT.cells <- subset(OS7.cx,
                     cells = temp)
  df <- table(LT.cells$Phase)
  bp <- ggplot(as.data.frame(df),
               aes(x="",
                   y=Freq,
                   fill=Var1)) +
    geom_bar(width = 1,
             stat = "identity")
  pie <- bp +
    coord_polar("y",
                start=0) +
    scale_fill_brewer(palette="Blues") +
    theme_minimal() +
    NoAxes() +
    NoLegend() +
    ggtitle(paste("Cluster",
                  cid[[i]]))
  
  print(pie,
        vp=vplayout(ceiling(i/4),
                    i))
}
dev.off()
```

## Figure 1C

C) Pathway enrichment analysis for hallmark gene sets associated with genes upregulated in distinct clusters identified in the two osteosarcoma models. P values were adjusted for multiple comparisons. Boxes in grey identify non-significant enrichments, whereas boxes in red identify statistically significant enrichments. MTORC1: mechanistic target of rapamycin (mTOR) complex 1. PI3K: Phosphoinositide 3-kinase. AKT: Protein kinase B. TGF: Transforming growth-factor. TNF: tumor necrosis factor. NFKB: Nuclear Factor kappa-light-chain-enhancer of activated B cells.

*Need correct input for this figure heatmap.*

```{r Fig1c_dgea, dependson='Fig1b_NCHOS7'}
# Pathway enrichment analysis
# Display adjust p-values
B.list <- list(OS17 = os17.cx,
               NCHOS7 = OS7.cx)

em.hm.list <- list()

for (i in 1:length(B.list)) {
  em.hm.list[[i]] <- DGEA(B.list[[i]])
}

for(i in 1:(length(em.hm.list))) {
  em.hm.list[[i]] <- setDT(em.hm.list[[i]],
                           keep.rownames = TRUE)[]
}

temp1 <- em.hm.list[[1]]
temp2 <- em.hm.list[[2]]
cx.pd <- full_join(temp1,
                   temp2,
                   by = "rn")

cx.pd <- column_to_rownames(cx.pd,
                            var = "rn")
cx.pd[is.na(cx.pd)] <- 1

#remove "HALLMARK_"
c <- rownames(cx.pd)
c <- gsub("HALLMARK_",
          "",
          c)

#remove "_" by removing special characters
c <- gsub("_",
          " ",
          c)
rownames(cx.pd) <- c

# Take the -log10
cx.pd.log <- -log10(cx.pd)
colnames(cx.pd.log) <- c("A0",
                         "A1",
                         "A2",
                         "B0",
                         "B1",
                         "B2",
                         "B3")

# To prevent values that show up as -0.00, we take the absolute values
cx.pd.log <- abs(cx.pd.log)

figure_1c <- cx.pd.log %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "Sample") %>%
  pivot_longer(c(-Sample),
               names_to = "Pathway",
               values_to = "pval",
               names_repair = "minimal") %>%
  mutate(Signif = pval >= (-1 * log10(0.05))) %>%
  ggplot(.,
         aes(x = Sample,
             y = Pathway,
             fill = Signif)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%0.2f",
                                pval))) + 
  scale_fill_manual(values = c("gray",
                               "red")) +
  scale_y_discrete(limits = rev,
                   position = "right") +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("")
figure_1c

#Save as PDF
pdf("figures/figure_1/figure_1c.pdf",
    width = 8,
    height = 8)
figure_1c
dev.off()
```

# Figure 2

Figure 2. Osteosarcoma cells adopt distinct transcriptional profiles as they colonize tibia and lung microenvironments. A) Schematic of study design depicting generation of orthotopic primary and metastatic tumors. Tumors were harvested for scRNA-seq when mice reached endpoint.

## Figure 2B

B) Venn diagrams showing overlap of differentially expressed genes that are up- or down- regulated in primary or metastatic tumors relative to corresponding starting population of cells (cell line or PDX flank tumors). Region outlined in red identifies differentially expressed genes shared across at least three models.

```{r Fig2b, fig.height=10, fig.width=10}
load("Data/OS_merged_postCCR.RData")
# Set seed before subsetting and DE analysis to ensure consistent results
set.seed(100)

OS$tissue <- OS$src %>%
  stringr::str_replace("Flank", "Culture")

OS <- subset(OS, subset = model != "OB")

Idents(OS) <- OS$tissue

de_out <- list()
for (tissue_name in c("Tibia", "Lung")) {
  for (cl_name in unique(OS$model)) {
    message(tissue_name, " ", cl_name)
    temp_seurat <- subset(OS, subset = (tissue == tissue_name |
                                          tissue == "Culture") &
                            model == cl_name)
    temp_de_out <-
      FindMarkers(temp_seurat,
                  ident.1 = tissue_name,
                  ident.2 = "Culture",
                  min.pct = 0.1) %>%
      filter(p_val_adj <= 0.05)
    
    de_out[[tissue_name]][["up"]][[cl_name]] <-
      temp_de_out %>%
      filter(avg_log2FC > 0) %>%
      rownames()
    
    de_out[[tissue_name]][["down"]][[cl_name]] <-
      temp_de_out %>%
      filter(avg_log2FC < 0) %>%
      rownames()
    
    rm(temp_seurat, temp_de_out)
  }
}

figure_2b <- list()
for (tissue_name in c("Tibia", "Lung")) {
  for (direction in c("up", "down")) {
    figure_2b[[paste0(tissue_name,
                      " - ",
                      direction)]] <-
      ggvenn::ggvenn(de_out[[tissue_name]][[direction]],
                     fill_color = c("#0073C2FF",
                                    "#EFC000FF",
                                    "#868686FF",
                                    "#CD534CFF"),
                     stroke_size = 0.1,
                     set_name_size = 2,
                     text_size = 1.3,
                     show_percentage = TRUE) +
      ggtitle(paste0(tissue_name,
                     " - ",
                     direction)) +
      theme(plot.title = element_text(hjust = 0.5,
                                      vjust = -8,
                                      size = 10,
                                      face = "bold"),
            plot.margin = margin(-2, 0, -2, 0, "cm"))
    
    # Fix the position of the bottom two set names
    figure_2b[[paste0(tissue_name,
                      " - ",
                      direction)]]$layers[[3]]$data$x <- 
      c(-1, -0.8, 0.8, 1)
  }
}

#Save as PDF
pdf("figures/figure_2/figure_2b.pdf",
    width = 4,
    height = 4)
# Put all four plots into one image
gridExtra::grid.arrange(grobs = figure_2b,
                        vp = viewport(width = 1.0, height = 0.9))
dev.off()

# Save RData obj
save(figure_2b, file = "figures/figure_2/figure_2b.RData")
```

## Figure 2C

C) Pathway enrichment analysis with adjusted p values for hallmark gene sets associated with these shared genes

```{r Fig2c, dependson = "Fig2b", fig.height=6, fig.width=10}
### Extract genes that are shared in these datasets
load("Data/OS_merged_postCCR.RData")
# Set seed before subsetting and DE analysis to ensure consistent results
set.seed(100)

data <- list(
  os17 = subset(OS, cells = WhichCells(OS, expression = model == "OS-17")),
  t143B = subset(OS, cells = WhichCells(OS, expression = model == "143B")),
  NCHOS2 = subset(OS, cells = WhichCells(OS, expression = model == "NCH-OS-2")),
  NCHOS7 = subset(OS, cells = WhichCells(OS, expression = model == "NCH-OS-7"))
)

# Rename "Flank" to "Culture" for NCHOS samples
data$NCHOS2$src[grep("Flank", data$NCHOS2$src)] <- "Culture"
data$NCHOS7$src[grep("Flank", data$NCHOS7$src)] <- "Culture"

fig_2c_data <- tibble()

for (tissue_name in c("Tibia", "Lung")) {
  for (direction in c("up", "down")) {
    de_genes <- list()
    for (i in seq_len(length(data))) {
      Idents(data[[i]]) <- data[[i]]$src
      de_genes[[i]] <-
        FindMarkers(data[[i]],
                    ident.1 = tissue_name,
                    ident.2 = "Culture",
                    only.pos = FALSE,
                    min.pct = 0.1)
      
      # Select genes that change in the direction of interest
      if (direction == "up") {
        de_genes[[i]] <-
          de_genes[[i]][de_genes[[i]]$p_val_adj < 0.05 &
                          de_genes[[i]]$avg_log2FC > 0, ]
      } else {
        de_genes[[i]] <-
          de_genes[[i]][de_genes[[i]]$p_val_adj < 0.05 &
                          de_genes[[i]]$avg_log2FC < 0, ]
      }
    }
    
    A <- rownames(de_genes[[1]])
    B <- rownames(de_genes[[2]])
    C <- rownames(de_genes[[3]])
    D <- rownames(de_genes[[4]])
    
    # Preparing clusterProfiler to perform hypergeometric test on msigdb signatures 
    msig.gene.set <-
      msigdbr(species = "Homo sapiens", category = "H") %>%
      dplyr::select(gs_name, human_gene_symbol)
    msig.name <-
      msigdbr(species = "Homo sapiens", category = "H") %>%
      dplyr::select(gs_id, gs_name)
    
    # Getting middle "flower" of the Venn diagram
    intersect <- c((intersect(intersect(intersect(A, B), C), D)),
                   (intersect(intersect(A, B), C)),
                   (intersect(intersect(A, B), D)),
                   (intersect(intersect(A, D), C)),
                   (intersect(intersect(B, D), C))) %>%
      unique()
    
    temp <-
      enricher(intersect,
               TERM2GENE = msig.gene.set,
               TERM2NAME = msig.name)@result %>%
      as_tibble() %>%
      select(ID, p.adjust) %>%
      dplyr::rename(pathway = ID) %>%
      arrange(p.adjust) %>%
      slice_head(n = 5) %>%
      mutate(tissue = tissue_name,
             label_y = if_else(direction == "up", 1, -1),
             p.adjust = -log10(p.adjust),
             pathway = str_remove(pathway, "HALLMARK_") %>%
               str_replace_all("_", " "),
             order = seq_len(n()))
    
    if (direction == "down") {
      temp$p.adjust <- temp$p.adjust * -1
    }
    
    fig_2c_data <- bind_rows(fig_2c_data, temp)
  }
}

################ Two sided Barplot
# Properly name and order tissue types
fig_2c_data <- fig_2c_data %>%
  mutate(tissue = stringr::str_replace(tissue,
                                       "Tibia",
                                       "Tibia Gene Sets") %>%
           stringr::str_replace("Lung",
                                "Lung Gene Sets"),
         pathway = stringr::str_wrap(pathway, width = 25))

fig_2c_data$tissue <- factor(as.factor(fig_2c_data$tissue),
                             levels = c("Tibia Gene Sets",
                                        "Lung Gene Sets"))

# Create tibble that is properly ordered to use in proper plotting of tibia and lung data
lab4plot <- tibble(y = c(-4, 4, -4, 4),
                   x = c(0.5, 0.5, 0.5, 0.5),
                   label = as.factor(c("Downregulated\nduring tibia colonization",
                                       "Upregulated\nduring tibia colonization",
                                       "Downregulated\nduring lung colonization",
                                       "Upregulated\nduring lung colonization")),
                   tissue = factor(as.factor(c("Tibia Gene Sets",
                                               "Tibia Gene Sets",
                                               "Lung Gene Sets",
                                               "Lung Gene Sets")),
                                   levels = c("Tibia Gene Sets",
                                              "Lung Gene Sets")))

figure_2c <-
  ggplot() +
  geom_bar(data = fig_2c_data,
           aes(x = -1 * order,
               y = p.adjust,
               fill = p.adjust > 0),
           stat = "identity",
           alpha = 0.8) +
  coord_flip() +
  facet_wrap(~tissue,
             ncol = 1,
             scales = "free") +
  geom_hline(yintercept = c(-1.5, 1.5),
             color = "gray",
             linetype = 2,
             size = 1) +
  geom_hline(yintercept = 0,
             color = "black",
             size = 1) +
  geom_text(data = fig_2c_data,
            aes(x = -1 * order,
                y = label_y * 4,
                label = pathway)) +
  geom_text(data = lab4plot,
            aes(x = x,
                y = y,
                label = label),
            fontface = "bold") +
  scale_fill_manual(values = c("#377eb8", "#e41a1c")) +
  theme_bw() +
  theme(strip.background = element_rect(color = "white", fill = "white"),
        strip.text.x = element_text(size = 20, face = "bold"),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(title = "",
       y = "",
       x = "") +
  ylim(-7, 7) +
  xlim(-5.5, 1)
# Take a moment to ensure reset to null device
dev.off()

figure_2c

# Save as PDF
pdf("figures/figure_2/figure_2c.pdf",
    width = 6,
    height = 9)
figure_2c
dev.off()


save(figure_2c, file = "figures/figure_2/figure_2c.RData")
```

# Figure 3

Figure 3. Osteosarcoma cells retain phenotypic heterogeneity despite adaptive changes in response to changing microenvironments. A) Schematic outlining scRNA-seq bioinformatics workflow. In B-D, samples subset to equal number of cells to allow inter-model comparison (n=1500 per condition).

## Figure 3B

*statistical method subject to change*

B) Osteosarcoma cells exhibited higher ITH scores than that of osteoblasts grown in cell culture (####p <0.001). Within model comparison, identified increase in ITH scores as cells colonize tibia and lung microenvironments, with the exception of NCH-OS-7 (****p <0.001). P values were adjusted using Šidák multiple comparisons test.

```{r Fig3b}
# Load OS data that was subsetted to be equal cell numbers across 
load("Data/OSlist_1500_CCR.RData")

ITH.score <- list()
for (i in 1:length(OS.list_1500)) {
  z <- (Embeddings(OS.list_1500[[i]], reduction = "pca")[, 1:20])
  mat <- dist(z, diag = TRUE, upper = FALSE)
  mat2 <- as.matrix(mat)
  mat2[upper.tri(mat2, diag = TRUE)] <- NA
  ITH.score[[i]] <- colMeans(mat2, na.rm = TRUE)
}

#library(xlsx)
for (i in c(1:12)){
  as.data.frame(ITH.score[i]) %>%
    write_excel_csv(file=paste("Data/ITH/",i,"test.csv"))
}

raw_ith <- read_pzfx("ITH_Scores_1500.pzfx",
                     table = 1)

ith <- melt(raw_ith)
colnames(ith) <- c("Sample", "ITHScore")
ith$logITH <- log10(ith$ITHScore)
ridge_cols <- c("#B8B8B8FF",
                "#D43F3AFF", "#D43F3AFF", "#D43F3AFF",
                "#EEA236FF", "#EEA236FF", "#EEA236FF",
                "#357EBDFF", "#357EBDFF", "#357EBDFF",
                "#5CB85CFF", "#5CB85CFF", "#5CB85CFF"
)
rplot <- ggplot(ith, aes(x = logITH, y = Sample, fill = Sample)) +
  geom_density_ridges(scale = 2) +
  scale_y_discrete(expand = c(0, 0), limits = rev) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = ridge_cols) +
  theme_ridges() +
  xlab("log[ITH Score]") +
  theme(legend.position = "none",
        axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_blank())

rplot

# Perform a Mann-Whitney U for each group
comps <- tribble(
  ~ctl, ~comp,
  1, 2,
  1, 5,
  1, 8,
  1, 11,
  2, 3,
  2, 4,
  5, 6,
  5, 7,
  8, 9,
  8, 10,
  11, 12,
  11, 13
)
# Calculate Mann-Whitney test (in figure, p-value)
stats <- matrix(nrow = 13, ncol = 2)
mwu <- matrix(nrow = 13, ncol = 13)
for(i in seq_along(comps$ctl)) {
  s <- wilcox.test(raw_ith[,comps$ctl[i]], raw_ith[,comps$comp[i]])
  #P-value of comparison group (column)
  #correlated with its respective proper control (row)
  mwu[comps$ctl[i], comps$comp[i]] <- s$p.value
  #P-value for each group given proper comparison to respective controls
  stats[comps$comp[i]] <- s$p.value
}
# Calculate effect size (in figure)
efs <- matrix(nrow = 13, ncol = 13)
for(i in seq_along(comps$ctl)) {
  s <- cohen.d(raw_ith[,comps$ctl[i]], raw_ith[,comps$comp[i]])
  #Effect size of comparison group (column)
  #correlated with its respective proper control (row)
  efs[comps$ctl[i], comps$comp[i]] <- s$estimate
  #Effect size for each group given proper comparison to respective controls
  stats[comps$comp[i], 2] <- s$estimate
}
# Other statistical test - permutation
#per <- matrix(nrow = 13, ncol = 13)
#for(i in seq_along(comps$ctl)) {
#  s <- permTS(raw_ith[,comps$ctl[i]], raw_ith[,comps$comp[i]], alternative = "two.sided")
#  per[comps$ctl[i], comps$comp[i]] <- s$p.value
#}

# Save table of comparison group (column) correlated with its proper control (row)
as.data.frame(mwu) %>%
  write_excel_csv(file="Data/ITH/mwu.csv")
as.data.frame(efs) %>%
  write_excel_csv(file="Data/ITH/efs.csv")

# Correlate p-values with Sample name
stats <- as.data.frame(stats)
stats$Sample <- base::unique(ith[["Sample"]]) %>%
  as.vector()
stats <- stats[-1,]

# Plot with p-values superimposed for each sample
figure_3b <- rplot + geom_text(data=stats,
                               aes(x=1.9, y=Sample),
                               label = paste0("p=", format(stats$V1, digits=3, trim=TRUE),
                                              ", effect size=", format(stats$V2, digits=3, trim=TRUE), "\n"),
                               size = 3)
figure_3b

# Save as PDF
pdf("figures/figure_3/figure_3b.pdf",
    width = 8,
    height = 8)
figure_3b
dev.off()
```

## Figure 3C

C) UMAP analysis for merged primary and metastatic samples in each of the four models. Cells in grey represent remaining cells in merged sample. Cluster enrichment analysis shows distribution of cells in each cluster in the two microenvironment conditions (tibia, lung). While some cells in the primary and metastatic lesions adopted shared phenotypes, others adopted distinct phenotypes.

```{r Fig3c}
load("Data/OS_list_CCR.RData")

OS_list$OS17_TL <- OS_list$OS17_TL %>%
  FindClusters(resolution = 0.2)
OS_list$`143B_TL` <- OS_list$`143B_TL` %>%
  FindClusters(resolution = 0.15)
OS_list$NCHOS2_TL <- OS_list$NCHOS2_TL %>%
  FindClusters(resolution = 0.15)
OS_list$NCHOS7_TL <- OS_list$NCHOS7_TL %>%
  FindClusters(resolution = 0.2)

# Cluster distribution in each sample
# proportion of cells in lung in each cluster
lung_prop_tbl <- tibble()
for (s_obj in c(OS_list$OS17_TL,
                OS_list$`143B_TL`,
                OS_list$NCHOS2_TL,
                OS_list$NCHOS7_TL)) {
  s_obj$src <- factor(s_obj$src,
                      levels = c("Tibia",
                                 "Lung"))
  lung_prop_tbl <-
    s_obj@meta.data %>%
    as_tibble() %>%
    select(model, src, seurat_clusters) %>%
    group_by(model, seurat_clusters) %>%
    summarize(lung_perc = sum(grepl("Lung", src)) / n() * 100,
              .groups = "drop") %>%
    dplyr::rename(sample = model,
                  cluster = seurat_clusters) %>%
    bind_rows(lung_prop_tbl)
}

write_tsv(lung_prop_tbl, "Data/Fig3d_lung_prop_tbl.tsv")

#### UMAP Plots ####
sample_names <- c("OS17_TL",
                  "143B_TL",
                  "NCHOS2_TL",
                  "NCHOS7_TL")

for (s_obj in sample_names) {
  # Tibia plot with lung-derived cells greyed out
  temp_obj <- OS_list[[s_obj]]
  lung <- vector(mode = "character")
  temp <- WhichCells(temp_obj,
                     expression = src == "Lung")
  lung <- append(lung, temp)
  Idents(temp_obj, cells = lung) <- " "
  
  tibia_plot <- DimPlot(temp_obj,
                        reduction = "umap",
                        pt.size = 1,
                        label = T,
                        cols = c("light grey",
                                 "#E64B35FF",
                                 "#4DBBD5FF",
                                 "#00A087FF",
                                 "#3C5488FF"),
                        order = T) +
    coord_fixed() +
    NoLegend() +
    NoAxes() +
    ggtitle(s_obj, subtitle = "Tibia") +
    theme(plot.title = element_text(hjust = 0.5))
  
  # Lung plot with lung-derived cells greyed out
  temp_obj2 <- OS_list[[s_obj]]
  tib <- vector(mode = "character")
  temp <- WhichCells(temp_obj2,
                     expression = src == "Tibia")
  tib <- append(tib, temp)
  Idents(temp_obj2, cells = tib) <- " "
  
  lung_plot <- DimPlot(temp_obj2,
                       reduction = "umap",
                       pt.size = 1,
                       label = T,
                       cols = c("light grey",
                                "#E64B35FF",
                                "#4DBBD5FF",
                                "#00A087FF",
                                "#3C5488FF"),
                       order = T) +
    coord_fixed() +
    NoLegend() +
    NoAxes() +
    ggtitle("", subtitle ="Lung") +
    theme(plot.title = element_text(hjust = 0.5))
  
  combined <- tibia_plot + lung_plot
  
  pdf(paste0("figures/figure_3/figure_3c1_",
             s_obj,
             ".pdf"),
      width = 5,
      height = 5)
  print(combined)
  dev.off()
}

#### Bar plots ####
objlist <- c(OS_list$OS17_TL,
             OS_list$`143B_TL`,
             OS_list$NCHOS2_TL,
             OS_list$NCHOS7_TL)

for (sobj in objlist) {
  tident <- table(Idents(sobj),
                  sobj$src,
                  dnn = c("cluster",
                          "tissue")) %>%
    as.data.frame() %>%
    group_by(tissue) %>%
    mutate(perc = Freq / sum(Freq) * 100)
  
  tident$cluster <- as.character(tident$cluster)
  tident$tissue <- factor(tident$tissue, levels = c("Tibia", "Lung"))
  figure_3c2 <- ggplot(tident,
                       aes(x = tissue,
                           y = perc,
                           fill = cluster)) +
    theme_bw(base_size = 5) +
    geom_col(position = "fill", width = 0.5) +
    xlab("Tissue") +
    ylab("Proportion") +
    scale_fill_npg(alpha = 1) +
    NoLegend() +
    NoAxes() +
    #scale_fill_manual(values = c("#E64B35FF","#00A087FF","#4DBBD5FF",)
    theme(legend.title = element_blank())
  
  # Save plot as PDF
  pdf(paste0("figures/figure_3/figure_3c2_",
             head(sobj$model,1),
             ".pdf"),
      width = 1,
      height = 2)
  print(figure_3c2)
  dev.off()
}

# For Rmd visual
figure_3c2 <- ggplot(tident,
                     aes(x = tissue,
                         y = perc,
                         fill = cluster)) +
  theme_bw(base_size = 5) +
  geom_col(position = "fill", width = 0.5) +
  xlab("Tissue") +
  ylab("Proportion") +
  scale_fill_npg(alpha = 1)
figure_3c2
```

## Figure 3D

D) Metabolic heterogeneity in glycolysis activation. We used a pathway enrichment
analysis for hallmark gene sets using genes differentially upregulated in each
cluster relative to every other cluster within the same model. P values were
adjusted for multiple comparisons. Boxes in grey identify non-significant pathway
enrichments, whereas boxes in red identify statistically significant enrichments.
Bar plot shows percentage of cells identified per cluster in lung metastases.
In B-D, samples subset to equal number of cells to allow inter-model comparison
(n=1500 per condition).

### Processing

```{r Fig3d_process, dependson='Fig3c'}
library(data.table)
#library(pheatmap)
#Create list of objects used in Figure 3 heatmap
B.list <- list(OS17 = OS_list$`OS17_TL`,
               t143b = OS_list$`143B_TL`,
               OS2 = OS_list$`NCHOS2_TL`,
               OS7 = OS_list$`NCHOS7_TL`)

# Use DGEA function to find hallmark pathway expression
em.hm.list <- list()
set.seed(1337)
for (i in seq_len(length(B.list))) {
  em.hm.list[[i]] <- DGEA(B.list[[i]]) %>%
    setDT(keep.rownames = TRUE) %>%
    as_tibble() %>%
    rename_with(.cols = where(is.numeric), ~ str_c(names(B.list[i]), "_", .x))
}

cx.pd <- inner_join(inner_join(em.hm.list[[1]],
                               em.hm.list[[2]],
                               by = "rn"),
                    inner_join(em.hm.list[[3]],
                               em.hm.list[[4]],
                               by = "rn"),
                    by = "rn")

# Make the "rn" column the rownames -Emily
# cx.pd <- cx.pd %>%
#     column_to_rownames("rn")

head(cx.pd)
##Write table to edit rownames to easily convert to dataframe
write_tsv(cx.pd, file = "Data/cxpd.tsv")
```

### Code I gave to Sanjana at some point for Figure 3d
I modified this from code she gave me to clean it up and get it working

The only data we need are the cs.pd object and the percent of lung cells per cluster
which is entered here as aka4
```{r Fig3d}
lung_percent <-
  read_tsv("Data/Fig3d_lung_prop_tbl.tsv") %>%
  mutate(sample_order = rank(sample) * 1000 - lung_perc,
         x_label = paste0(sample, " c", cluster) %>%
           reorder(sample_order))

cx.pd <-
  read_tsv("Data/cxpd.tsv",
           show_col_types = FALSE) %>%
  pivot_longer(c(-rn),
               names_to = "sample",
               values_to = "pval") %>%
  mutate(cluster = str_remove(sample, ".+_") %>%
           as.numeric(),
         sample = str_replace(sample, "OS2", "NCH-OS-2") %>%
           str_replace("OS7", "NCH-OS-7") %>%
           str_replace("t143b", "143B") %>%
           str_replace("OS17", "OS-17") %>%
           str_remove("_.+"),
         rn = str_remove(rn, "HALLMARK_") %>%
           str_replace("_", " ")) %>%
  left_join(lung_percent) %>%
  mutate(pval = -log10(pval),
         sample_order = rank(sample) * 1000 - lung_perc,
         signif_bool = pval >= (-1 * log10(0.05)),
         signif = if_else(signif_bool == TRUE, "p-value < 0.05", "p-value > 0.05"))

P1 <-
  cx.pd %>%
  ggplot(., aes(x = x_label, y = rn, fill = signif)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%0.2f", pval)), size = 3) +
  scale_fill_manual(values = c("red", "gray"), name = "") +
  scale_y_discrete(limits = rev, position = "right") +
  theme(panel.background = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "cm"),
        panel.border = element_rect(colour = "black", fill = NA),
        axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.4,
                                   size = 12),
        axis.text.y = element_text(size = 12)) +
  labs(x = "",
       y = "") +
  facet_grid(. ~ sample,
             scales = "free_x",
             space = "free")

P2 <-
  lung_percent %>%
  ggplot(., aes(x = x_label, y = lung_perc, fill = sample)) +
  geom_bar(stat = "identity") +
  ylab("Percent\nin lung") +
  xlab("") +
  labs(fill = "Model",
       y = "Percent in\nlung (%)") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        plot.margin = unit(c(0, 0, -0.2, 0), "cm"),
        panel.border = element_rect(colour = "black", fill = NA)) +
  facet_grid(. ~ sample,
             scales = "free_x",
             space = "free")

figure_3d <- cowplot::plot_grid(P2,
                                P1,
                                ncol = 1,
                                align = "v",
                                rel_heights = c(2, 10))
figure_3d

pdf("figures/figure_3/figure_3d.pdf",
    width = 15,
    height = 8)
figure_3d
dev.off()
```

# Figure 4 - Images

Figure 4. Heterogeneity in Glycolysis activation identified within metastatic osteosarcoma lesions.

Figure 4 of this paper is composed of microscopy images and so is not part of the code for this paper. 

# Figure 5

Figure 5. Lung colonization bottleneck enriches for clonal populations with a common transcriptional phenotype. A) Schematic of experimental set-up. B) UMAP analysis of lineage tagged OS-17 cells in culture, implanted into tibia, or inoculated to generate lung metastases. These lineage tags are heritable allowing us to track the transcriptional profiles of daughter cells originating from the same ancestor. Metastatic and orthotopic samples share many cells with similar phenotypes, though cultured cells are dramatically different (n = 2800 per condition) C) Frequency distribution of clones identified in each of the conditions. A high level of clonal diversity is maintained in the orthotopic tumors (78% unique clones in primary tumor compared to 86% unique clones in cell culture); though dominant clones emerge in the lung (only 33% unique clones). D) Overlay of cells sharing a common ancestor onto the dimensional reduction plots in the top four enriched clonal families. E) UMAP visualization of cells belonging to top ten enriched clonal families highlighted in red. F) Pathway enrichment analysis for hallmark gene sets comparing enriched clones relative to the remaining metastatic tumor cells identifies Hypoxia, Glycolysis, EMT and MTORC1 signaling related genes to be significantly upregulated

### Load

```{r Fig5load}
source("scSeurat.R")

# Load raw objects for lineage tag analysis
load("Data/Raw/os17.cx.raw.RData")
load("Data/Raw/os17.tib.raw.RData")
load("Data/Raw/os17.lung.raw.RData")

# Subset all to 2800 cells in each condition
set.seed(108)
os17.cx.raw <- subset(os17.cx.raw,
                      cells = sample(Cells(os17.cx.raw),
                                     2800))
os17.tib.raw <- subset(os17.tib.raw,
                       cells = sample(Cells(os17.tib.raw),
                                      2800))
os17.lung.raw <- subset(os17.lung.raw,
                        cells = sample(Cells(os17.lung.raw),
                                       2800))

# Load merged and cell cycle regressed OS17 object
load("Data/os17.RData")
```

## Figure 5B

B) UMAP analysis of lineage tagged OS-17 cells in culture, implanted into tibia, or inoculated to generate lung metastases. These lineage tags are heritable allowing us to track the transcriptional profiles of daughter cells originating from the same ancestor. Metastatic and orthotopic samples share many cells with similar phenotypes, though cultured cells are dramatically different (n = 2800 per condition)

```{r Fig5b, dependson="Fig5load"}
# Set cell identities to proper cluster resolution 
Idents(os17) <- os17$RNA_snn_res.0.3

# Plot os17
set.seed(100)
os17$src <- factor(os17$src, levels = c("Culture", "Tibia", "Lung"))
figure_5b <- DimPlot(os17,
                     reduction = "umap",
                     group.by = "src",
                     pt.size = 1,
                     label = T,
                     order = T) +
  coord_fixed() +
  ggtitle(" ") +
  scale_color_npg()

figure_5b

# Save as PDF
pdf("figures/figure_5/figure_5b.pdf",
    width = 8,
    height = 4)
figure_5b
dev.off()
```

## Figure 5C

C) Frequency distribution of clones identified in each of the conditions. A high level of clonal diversity is maintained in the orthotopic tumors (78% unique clones in primary tumor compared to 86% unique clones in cell culture); though dominant clones emerge in the lung (only 33% unique clones). 

```{r Fig5c, dependson="Fig5load"}
# Plot histograms of lineage tracing tags in the Seurat objects
figure_5c1 <- processLTBC(os17.cx.raw,
                          lt.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0016/outs/lt.fq",
                          cid.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0016/outs/cid.fq",
                          histogram = T,
                          plot.only = T,
                          title = "Culture, Top 40 Clones",
                          ymax = 1.75,
                          col.fill = "#E64B35FF",
                          relative = T)

# Save as PDF
pdf("figures/figure_5/figure_5c1.pdf",
    width = 8,
    height = 2)
figure_5c1
dev.off()

figure_5c2 <- processLTBC(os17.tib.raw,
                          lt.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0018xS0028/outs/lt.fq",
                          cid.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0018xS0028/outs/cid.fq",
                          histogram = T,
                          plot.only = T,
                          title = "Tibia, Top 40 Clones",
                          ymax = 1.75,
                          col.fill = "#00A087FF",
                          relative = T)

# Save as PDF
pdf("figures/figure_5/figure_5c2.pdf",
    width = 8,
    height = 2)
figure_5c2
dev.off()

figure_5c3 <- processLTBC(os17.lung.raw,
                          lt.loc = "/gpfs0/home2/gdrobertslab/lab/Counts/S0024xS0029/outs/lt.fq",
                          cid.loc = "/gpfs0/home2/gdrobertslab/lab/Counts/S0024xS0029/outs/cid.fq",
                          histogram = T,
                          plot.only = T,
                          title = "Lung, Top 40 Clones",
                          ymax = 1.75,
                          relative = T)

# Save as PDF
pdf("figures/figure_5/figure_5c3.pdf",
    width = 8,
    height = 2)
figure_5c3
dev.off()
```

Determine number of unique clones for each tissue.

```{r uniquelt, dependson='Fig5b'}
# Determine number of unique LTs
length((os17.cx.raw$lt))
length(unique(os17.cx.raw$lt))
(length(unique(os17.cx.raw$lt))/length((os17.cx.raw$lt)))*1000

length((os17.tib.raw$lt))
length(unique(os17.tib.raw$lt))
(length(unique(os17.tib.raw$lt))/length((os17.tib.raw$lt)))*1000

length((os17.lung.raw$lt))
length(unique(os17.lung.raw$lt))
(length(unique(os17.lung.raw$lt))/length((os17.lung.raw$lt)))*1000
```

## Figure 5D

D) Overlay of cells sharing a common ancestor onto the dimensional reduction plots in the top four enriched clonal families.

### Processing

```{r Fig5d_processing, dependson="Fig5load"}
# Extract the barcode frequency lists
cx.lt.list <- processLTBC(os17.cx.raw,
                          lt.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0016/outs/lt.fq",
                          cid.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0016/outs/cid.fq",
                          ret.list = TRUE)

tib.lt.list <- processLTBC(os17.tib.raw,
                           lt.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0018xS0028/outs/lt.fq",
                           cid.loc = "/gpfs0/home/gdrobertslab/lab/Counts/S0018xS0028/outs/cid.fq",
                           ret.list = TRUE)

lung.lt.list <- processLTBC(os17.lung.raw,
                            lt.loc = "/gpfs0/home2/gdrobertslab/lab/Counts/S0024xS0029/outs/lt.fq",
                            cid.loc = "/gpfs0/home2/gdrobertslab/lab/Counts/S0024xS0029/outs/cid.fq",
                            ret.list = TRUE)

# Subset the three samples, but retain the current umap data
cx.sub <- subset(os17, subset = src == "Culture")
tib.sub <- subset(os17, subset = src == "Tibia")
lung.sub <- subset(os17, subset = src == "Lung")

# Subset to cells that have a lineage tag
# Culture
Culture.LTcells <- vector(mode = "character")
for (i in 1:nrow(cx.lt.list)) {
  temp <- WhichCells(cx.sub,
                     expression = lt == cx.lt.list[[i, 1]])
  Culture.LTcells <- append(Culture.LTcells,
                            temp)
}
cx.tagged <- subset(cx.sub,
                    cells = Culture.LTcells)

figure_5c1_umap <- DimPlot(cx.tagged,
                           group.by = "src") +
  coord_fixed() +
  scale_color_npg(alpha = 1) +
  ggtitle(" ") +
  NoLegend() + NoAxes()
figure_5c1_umap

# Save as PDF
pdf("figures/figure_5/figure_5c1_umap.pdf",
    width = 3,
    height = 3)
figure_5c1_umap
dev.off()

# Tibia
# Remove outlier cells (names may vary in different runs of the code)
tib.sub <- subset(tib.sub,
                  idents = c("0",
                             "1",
                             "3",
                             "6")) 

tib.LTcells <- vector(mode = "character")
for (i in 1:nrow(tib.lt.list)) {
  temp <- WhichCells(tib.sub,
                     expression = lt == tib.lt.list[[i, 1]])
  tib.LTcells <- append(tib.LTcells, temp)
}
tib.tagged <- subset(tib.sub,
                     cells = tib.LTcells)

figure_5c2_umap <- DimPlot(tib.tagged,
                           group.by = "src",
                           cols = "#00A087FF") +
  coord_fixed() +
  ggtitle(" ") +
  NoLegend() + NoAxes()
figure_5c2_umap

# Save as PDF
pdf("figures/figure_5/figure_5c2_umap.pdf",
    width = 3,
    height = 3)
figure_5c2_umap
dev.off()

# Lung
# Remove outlier cells (names may vary in different runs of the code)
lung.sub <- subset(lung.sub,
                   idents = c("0",
                              "1",
                              "3",
                              "6"))

lung.LTcells <- vector(mode = "character")
for (i in 1:nrow(lung.lt.list)) {
  temp <- WhichCells(lung.sub,
                     expression = lt == lung.lt.list[[i, 1]])
  lung.LTcells <- append(lung.LTcells,
                         temp)
}
lung.tagged <- subset(lung.sub,
                      cells = lung.LTcells)

figure_5c3_umap <- DimPlot(lung.tagged,
                           group.by = "src",
                           cols = "#4DBBD5FF") +
  coord_fixed() +
  ggtitle(" ") +
  NoLegend() + NoAxes()
figure_5c3_umap

# Save as PDF
pdf("figures/figure_5/figure_5c3_umap.pdf",
    width = 3,
    height = 3)
figure_5c3_umap
dev.off()
```


### Culture Panel

```{r Fig5d_cx, dependson='Fig5d_processing', fig.height=10, fig.width=10}
# Culture
vplayout <- function(x,y) viewport(layout.pos.row = x,
                                   layout.pos.col = y)

pdf("figures/figure_5/figure_5d1_grid_culture.pdf",
    width = 10,
    height = 6)

grid.newpage()

pushViewport(viewport(layout = grid.layout(1,4)))

for (i in 1:4) {
  p <- DimPlot(cx.tagged,
               reduction = "umap",
               pt.size = 1,
               cells.highlight = WhichCells(cx.sub,
                                            expression = lt == cx.lt.list[[i, 1]]),
               cols.highlight = "#E64B35FF",
               sizes.highlight = 3) +
    coord_fixed() +
    theme(legend.position = "none") +
    ggtitle(paste("Clone",
                  cx.lt.list[[i,1]])) +
    NoLegend() +
    NoAxes()
  
  print(p, vp = vplayout(ceiling(i/4), i))
}
dev.off()
```

### Tibia Panel

```{r Fig5d_tibia, dependson='Fig5d_processing'}
# Tibia
vplayout <- function(x,y) viewport(layout.pos.row = x,
                                   layout.pos.col = y)

pdf("figures/figure_5/figure_5d2_grid_tibia.pdf",
    width = 10,
    height = 6)

grid.newpage()

pushViewport(viewport(layout = grid.layout(1,4)))

for (i in 1:4) {
  p <- DimPlot(tib.tagged,
               reduction = "umap",
               pt.size = 1,
               cells.highlight = WhichCells(tib.sub,
                                            expression = lt == tib.lt.list[[i, 1]]),
               cols.highlight = "#00A087FF",
               sizes.highlight = 3) +
    coord_fixed() +
    theme(legend.position = "none") +
    ggtitle(paste("Clone",
                  tib.lt.list[[i,1]])) +
    NoLegend() +
    NoAxes()
  
  print(p, vp = vplayout(ceiling(i/4), i))
}
dev.off()
```

### Lung Panel

```{r Fig5d_lung, dependson='Fig5d_processing'}
# Lung
vplayout <- function(x,y) viewport(layout.pos.row = x,
                                   layout.pos.col = y)

pdf("figures/figure_5/figure_5d3_grid_lung.pdf",
    width = 10,
    height = 6)

grid.newpage()

pushViewport(viewport(layout = grid.layout(1,4)))

for (i in 1:4) {
  p <- DimPlot(lung.tagged,
               reduction = "umap",
               pt.size = 1,
               cells.highlight = WhichCells(lung.sub,
                                            expression = lt == lung.lt.list[[i, 1]]),
               cols.highlight = "#4DBBD5FF",
               sizes.highlight = 3) +
    coord_fixed() +
    theme(legend.position = "none") +
    ggtitle(paste("Clone",
                  lung.lt.list[[i,1]])) +
    NoLegend() +
    NoAxes()
  
  print(p, vp = vplayout(ceiling(i/4), i))
}
dev.off()
```

## Figure 5E

E) UMAP visualization of cells belonging to top ten enriched clonal families highlighted in red.

```{r Fig5e, dependson='Fig5d_processing'}
# Compare Enriched vs non-enriched 
# Group first 10 against the tagged Lung
LT <- vector(mode = "character")

for (i in 1:10) {
  temp <- WhichCells(lung.tagged,
                     expression = lt == lung.lt.list[[i, 1]])
  LT <- append(LT, temp)
}

Idents(lung.tagged, cells = LT) <- "Enriched clones"

cell.ids <- sample(colnames(lung.tagged))

# Culture plots
figure_5e <- DimPlot(lung.sub,
                     reduction = "umap",
                     pt.size = 1,
                     cells.highlight = WhichCells(lung.tagged,
                                                  idents = "Enriched clones"),
                     cols.highlight = "#E64B35FF",
                     sizes.highlight = 2,
                     order = cell.ids) +
  coord_fixed() + 
  scale_color_discrete(name = "Clones",
                       type = c("#C3C3C3",
                                "#E64B35FF"),
                       labels = c("Unselected" = "Non-enriched clones",
                                  "Group_1" = "Enriched clones"))
figure_5e

pdf("figures/figure_5/figure_5e.pdf",
    width = 6,
    height = 5)
figure_5e
dev.off()
```

## Figure 5F

F) Pathway enrichment analysis for hallmark gene sets comparing enriched clones relative to the remaining metastatic tumor cells identifies Hypoxia, Glycolysis, EMT and MTORC1 signaling related genes to be significantly upregulated

```{r Fig5f, dependson='Fig5e'}
# Pathways associated with Enriched clonal families
source("Downstream.v2.R")

# Rename identities from the total lung tumor to include enriched clones
lung.sub.enr <- SetIdent(lung.sub,
                         cells = WhichCells(lung.tagged,
                                            idents = "Enriched clones"),
                         value = "Enriched clones")

# Analyze enriched clones against the remaining tumor cells in the lung
lung.sub.enr <- RenameIdents(lung.sub.enr,
                             "0" = "Remaining Tumor Cells",
                             "1" = "Remaining Tumor Cells",
                             "3" = "Remaining Tumor Cells",
                             "6" = "Remaining Tumor Cells")

B.list <- list(OS17 = lung.sub.enr)

# Perform differential gene expression analysis for hallmark pathways
set.seed(100)
em.hm.list <- list()
for (i in 1:length(B.list)) {
  em.hm.list[[i]] <- DGEA(B.list[[i]])
}

# Achieve -log10 of the p-value
temp1 <- em.hm.list[[1]]
temp1 <- -log10(temp1)

# Remove unnecessary characters
c <- rownames(temp1)
c <- gsub("_", " ", c)
c <- gsub("HALLMARK ", "", c) 
rownames(temp1) <- c

# Remove negative 0 values due to number of decimal points displayed
temp1 <- abs(temp1)
temp1 <- temp1["Enriched clones"]

# Subset to only pathways with significant pvalue (-1 * log10(0.05)) = 1.30103)
temp1["Enriched clones"] >= 1.30103 -> temp1$logical
colnames(temp1) <- c("pvalue",
                     "significant")
logical <- temp1$significant
temp1 <- temp1[logical, ]
temp1 <- rownames_to_column(temp1,
                            var = "Pathway")

# Order by -log10pvalue for plotting
temp1$Pathway <- factor(temp1$Pathway,
                        levels = temp1$Pathway[order(temp1$pvalue)])

# Plot 
figure_5f <- ggplot(temp1,
                    aes(x = pvalue,
                        y = Pathway)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  ylab("") +
  xlab("-log10(p-value)") +
  geom_vline(xintercept = 1.5,
             color = "gray",
             linetype = 2,
             size = 1)

figure_5f

pdf("figures/figure_5/figure_5f.pdf",
    width = 8,
    height = 3)
figure_5f
dev.off()
```

```{r session}
sessionInfo()
```
